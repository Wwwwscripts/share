name: Discord Notify

on:
  push:
    branches: ["*"]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 2
        
      - name: Send commit message to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          # kontrola, zda m√°me webhook
          if [ -z "$DISCORD_WEBHOOK" ]; then
            echo "Error: DISCORD_WEBHOOK secret is not set!"
            exit 1
          fi
          
          # z√≠sk√°me commit info
          MESSAGE=$(git log -1 --pretty=%B | tr '\n' ' ' | sed 's/"/\\"/g' | sed "s/'/\\'/g")
          AUTHOR="${{ github.actor }}"
          REPO="${{ github.repository }}"
          BRANCH="${{ github.ref_name }}"
          COMMIT_SHORT="${{ github.sha }}"
          COMMIT_SHORT="${COMMIT_SHORT:0:7}"
          COMMIT_URL="https://github.com/$REPO/commit/${{ github.sha }}"
          
          # vytvo≈ô√≠me JSON
          cat <<EOF > payload.json
          {
            "embeds": [{
              "title": "üìù New Commit in $REPO",
              "description": "$MESSAGE",
              "color": 5814783,
              "fields": [
                {"name": "üë§ Author", "value": "$AUTHOR", "inline": true},
                {"name": "üåø Branch", "value": "$BRANCH", "inline": true},
                {"name": "üîó Commit", "value": "[\`$COMMIT_SHORT\`]($COMMIT_URL)", "inline": false}
              ],
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"
            }]
          }
          EOF
          
          # ode≈°leme do Discordu
          curl -H "Content-Type: application/json" \
               -X POST \
               -d @payload.json \
               "$DISCORD_WEBHOOK"
